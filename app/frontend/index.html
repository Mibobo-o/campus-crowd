<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Campus Crowd (Demo)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{ --lv0:#2ecc71; --lv1:#f1c40f; --lv2:#e67e22; --lv3:#e74c3c; }
    body{ margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #topbar{ height:48px; display:flex; align-items:center; padding:0 12px; border-bottom:1px solid #eee; }
    #topbar h3{ margin:0; font-size:16px; font-weight:600; }
    #map{ height:calc(100vh - 48px); }

    /* ë²”ë¡€ ìŠ¤íƒ€ì¼ */
    .legend{
      background: #fff; padding:10px 12px; border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15); font-size:13px; line-height:1.5;
    }
    .legend .row{ display:flex; align-items:center; gap:8px; margin:4px 0; }
    .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; }
    .lv0{ background:var(--lv0); } .lv1{ background:var(--lv1); }
    .lv2{ background:var(--lv2); } .lv3{ background:var(--lv3); }

    /* íŒì—… ì•ˆì˜ ê°•ì¡° */
    .badge{
      display:inline-block; font-size:12px; padding:2px 6px; border-radius:999px; color:#fff;
    }
    .b0{ background:var(--lv0);} .b1{ background:var(--lv1); color:#000;}
    .b2{ background:var(--lv2);} .b3{ background:var(--lv3);}
    .meta{ color:#666; font-size:12px; }
  </style>
</head>
<body>
  <div id="topbar">
    <h3>Campus Crowd â€” í˜„ì¬ í˜¼ì¡ë„ ì§€ë„</h3>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // 0) ì§€ë„ ê¸°ë³¸
    const map = L.map('map').setView([37.501, 127.0], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

    // 1) ìƒ‰ìƒ/ë ˆë²¨ ê·œì¹™
    function levelFromRate(r){
      if (r < 0.3) return 0;
      if (r < 0.6) return 1;
      if (r < 0.8) return 2;
      return 3;
    }
    const COLORS = ['#2ecc71','#f1c40f','#e67e22','#e74c3c'];

    // í˜¼ì¡ë¹„ìœ¨ì— ë”°ë¼ ë§ˆì»¤ í¬ê¸°(ì‹œê° ê°€ë…ì„±â†‘)
    function radiusFromRate(r){
      // ìµœì†Œ 6px, ìµœëŒ€ 14px ì •ë„
      return 6 + Math.round(r * 8);
    }

    // 2) CSV ì½ê¸°(ì•„ì£¼ ë‹¨ìˆœ íŒŒì„œ)
    async function readCSV(path){
      const text = await fetch(path).then(r=>r.text());
      const lines = text.trim().split(/\r?\n/);
      const cols = lines[0].split(',');
      return lines.slice(1).map(line=>{
        // ì‰¼í‘œê°€ ì´ë¦„ì— ë“¤ì–´ê°€ì§„ ì•ŠëŠ” ì „ì œ(ìˆìœ¼ë©´ ë”°ì˜´í‘œ ì²˜ë¦¬ í•„ìš”)
        const vals = line.split(',');
        const row = {};
        cols.forEach((c,i)=> row[c] = vals[i]);
        return row;
      });
    }

    // 3) ë²”ë¡€ ì¶”ê°€
    const legend = L.control({position:'bottomright'});
    legend.onAdd = function(){
      const div = L.DomUtil.create('div','legend');
      div.innerHTML = `
        <div style="font-weight:600;margin-bottom:4px;">Occupancy Level</div>
        <div class="row"><span class="dot lv0"></span><span>&lt; 30% (Lv 0)</span></div>
        <div class="row"><span class="dot lv1"></span><span>30â€“60% (Lv 1)</span></div>
        <div class="row"><span class="dot lv2"></span><span>60â€“80% (Lv 2)</span></div>
        <div class="row"><span class="dot lv3"></span><span>â‰¥ 80% (Lv 3)</span></div>
      `;
      return div;
    };
    legend.addTo(map);

    // 4) ë©”ì¸ ë¡œì§
    async function main(){
      // ì •ì  ë°°í¬ í¸ì˜ë¥¼ ìœ„í•´ /app/frontend/data/ ì•„ë˜ì— CSV ë³µì‚¬í•´ ë‘ì—ˆìŒì„ ê°€ì •
      const locations = await readCSV('./data/locations_master.csv');
      const meas = await readCSV('./data/measurements.csv');

      // ìµœì‹  timestamp êµ¬í•˜ê¸°
      const latest = meas.reduce((a,b)=> a.timestamp > b.timestamp ? a : b).timestamp;
      const latestRows = meas.filter(r => r.timestamp === latest);

      // location_id => occupancy_rate ë§¤í•‘
      const rateMap = {};
      const levelMap = {};
      latestRows.forEach(r=>{
        const rate = parseFloat(r.occupancy_rate || '0');
        rateMap[r.location_id] = rate;
        levelMap[r.location_id] = levelFromRate(rate);
      });

      // íƒ€ì…ë³„ ì´ëª¨ì§€(íŒì—…ìš© ê°€ë…ì„± â†‘)
      const TYPE_ICON = {
        reading_room: 'ğŸ“–',
        cafeteria: 'ğŸ´',
        lecture: 'ğŸ«',
        cafe: 'â˜•',
        study_zone: 'ğŸ§‘â€ğŸ’»'
      };

      // ë§ˆì»¤ ë Œë”
      locations.forEach(loc=>{
        const lat = parseFloat(loc.lat), lon = parseFloat(loc.lon);
        if (isNaN(lat) || isNaN(lon)) return;

        const id = loc.id;
        const rate = rateMap[id] ?? 0;
        const lv   = levelMap[id] ?? levelFromRate(rate);
        const color= COLORS[lv];

        const marker = L.circleMarker([lat, lon], {
          radius: radiusFromRate(rate),
          color, fillColor: color, fillOpacity: 0.9, weight: 1
        }).addTo(map);

        const icon = TYPE_ICON[loc.type] || 'ğŸ“';
        const badgeClass = `b${lv}`;
        const pct = isFinite(rate) ? (rate*100).toFixed(0) : 'â€“';

        marker.bindPopup(`
          <div style="min-width:220px">
            <div style="font-weight:700;margin-bottom:4px;">${icon} ${loc.name}</div>
            <div class="meta">type: ${loc.type}${loc.capacity ? ` Â· cap: ${loc.capacity}`:''}</div>
            <div style="margin:8px 0;">
              <span class="badge ${badgeClass}">now ${pct}% Â· Lv ${lv}</span>
            </div>
            <div class="meta">timestamp: ${latest}</div>
          </div>
        `);

        // ë§ˆìš°ìŠ¤ì˜¤ë²„ íˆ´íŒ(ê°€ë³ê²Œ)
        marker.bindTooltip(`${loc.name} â€” ${pct}% (Lv ${lv})`, {direction:'top'});
      });
    }

    main();
  </script>
</body>
</html>
